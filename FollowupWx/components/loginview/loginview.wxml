<view class="login-container">
  <image src="/images/logo.png" mode="widthFix" style="width: 80px; margin-left: 30rpx;" />
  <view  class="login-title"> 
    <view>健康管家</view>
  <block wx:if="{{!isPatient}}">
    <view class="doctor-title">医生端</view>
  </block>
  </view>
  

  <view class="login-type-switch">
     <view class="{{loginType === 'verifyCode' ? 'active' : ''}}" bindtap="switchLoginType" data-type="verifyCode">
      验证码登录
    </view>
    <view class="divider"></view>
    <view class="{{loginType === 'password' ? 'active' : ''}}" bindtap="switchLoginType" data-type="password">
      密码登录
    </view>
  </view>

  <view class="login-form"> 
    <view class="input-group">
      <input type="number" 
             value="{{phoneNumber}}" 
             bindinput="handlePhoneInput" 
             placeholder="请输入您的手机号码" />
      <view class="error-text" wx:if="{{phoneError}}">{{phoneError}}</view>
    </view>

    <block wx:if="{{loginType === 'verifyCode'}}">
      <view class="input-group verify-code">
        <input type="number" 
               value="{{verifyCode}}" 
               bindinput="handleVerifyCodeInput" 
               placeholder="请输入手机验证码" />
        <view class="verify-code-btn {{!isPhoneValid || isCountingDown ? 'disabled' : 'active'}}" 
              bindtap="sendVerifyCode">
          {{isCountingDown ? countdown + '秒后重新获取' : '获取验证码'}}
        </view>
      </view>
      <view class="hint-text">验证码登录可一键注册或登录</view>
    </block>
    <block wx:else>
      <view class="input-group">
        <input password="{{!showPassword}}"
               value="{{password}}" 
               bindinput="handlePasswordInput" 
               placeholder="请输入密码" />
        <view class="toggle-password" bindtap="togglePassword">
          <text class="iconfont {{showPassword ? 'icon-eye' : 'icon-eye-slash'}}"></text>
        </view>
      </view>
    </block>

    <view class="wechat-login-wrapper">
      <button 
        class="wechat-btn {{isProcessingAuth ? 'processing' : ''}}" 
        open-type="getPhoneNumber" 
        bindgetphonenumber="handleWeixinLogin"
        disabled="{{isProcessingAuth}}"
      >
        <view class="btn-content">
          <view wx:if="{{isProcessingAuth}}" class="loading-wrapper">
            <van-loading type="spinner" size="20px" color="#ffffff" />
          </view>
          
          <text class="btn-text">{{authButtonText}}</text>
        </view>
      </button>
      
      <view wx:if="{{isProcessingAuth}}" class="auth-progress">
        <view class="progress-container">
          <view class="progress-step {{authStep === 'phone' ? 'active' : authStep === 'subscribe' || authStep === 'complete' ? 'completed' : ''}}">
            <view class="step-circle">
              <text wx:if="{{authStep === 'phone'}}" class="step-number">1</text>
              <text wx:elif="{{authStep === 'subscribe' || authStep === 'complete'}}" class="step-check">✓</text>
              <text wx:else class="step-number">1</text>
            </view>
            <text class="step-label">获取手机号</text>
          </view>
          
          <view class="progress-line {{authStep === 'subscribe' || authStep === 'complete' ? 'completed' : ''}}"></view>
          
          <view class="progress-step {{authStep === 'subscribe' ? 'active' : authStep === 'complete' ? 'completed' : ''}}">
            <view class="step-circle">
              <text wx:if="{{authStep === 'subscribe'}}" class="step-number">2</text>
              <text wx:elif="{{authStep === 'complete'}}" class="step-check">✓</text>
              <text wx:else class="step-number">2</text>
            </view>
            <text class="step-label">消息授权</text>
          </view>
        </view>
        
        <view class="current-step-hint">
          <text wx:if="{{authStep === 'phone'}}">正在获取您的手机号...</text>
          <text wx:elif="{{authStep === 'subscribe'}}">请在弹窗中确认消息订阅</text>
          <text wx:elif="{{authStep === 'complete'}}">授权完成，即将为您登录</text>
        </view>
      </view>
    </view>

    <button class="login-btn" bindtap="handleLogin">登录</button>

    <view class="agreement">
      <checkbox-group bindchange="handleAgreementChange">
        <checkbox value="agree" checked="{{agreeToTerms}}">我已阅读并同意</checkbox>
      </checkbox-group>
      <navigator url="/pages/privacyPolicy/privacyPolicy">隐私政策</navigator>
      <navigator url="/pages/agreement/agreement">用户协议</navigator>
      <text>和</text>
      <navigator url="/pages/terms/terms">服务条款</navigator>
    </view>

    <view class="error-message" wx:if="{{errorMessage}}">{{errorMessage}}</view>
  </view>
  <van-toast id="van-toast" />

  <!-- 订阅授权确认弹窗 -->
  <view class="subscribe-modal" wx:if="{{showSubscribeModal}}">
    <view class="modal-mask" bindtap="hideSubscribeModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title">开启消息通知</view>
        <view class="modal-close" bindtap="hideSubscribeModal">×</view>
      </view>
      
      <view class="modal-body">
        <view class="permission-tip">
          <image src="/images/message-icon.png" class="tip-icon" mode="aspectFit"></image>
          <view class="tip-text">
            <view class="tip-title">为了及时通知您重要信息</view>
            <view class="tip-desc">• 随访提醒通知</view>
            <view class="tip-desc">• 宣教消息通知</view>
          </view>
        </view>
        
        <view class="modal-note">
          您可以随时在小程序设置中管理消息通知权限
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn secondary" bindtap="skipSubscribeAuth">
          拒绝
        </button>
        <button class="modal-btn primary" bindtap="confirmSubscribeAuth">
          同意并授权
        </button>
      </view>
    </view>
  </view>
</view>