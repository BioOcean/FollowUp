@namespace FollowUp.Components.Shared

@* 统计数据项组件 - 统一的数据展示块（带动画和趋势指示） *@
<div class="statistic-item @GetAnimationClass()" style="@GetContainerStyle()">
    @if (!string.IsNullOrEmpty(Label))
    {
        <MudText Typo="@LabelTypo" Color="@LabelColor" Class="@($"{LabelClass} statistic-label")">
            @Label
        </MudText>
    }

    <div class="statistic-value-wrapper">
        <MudText Class="@GetValueClasses()"
                 Typo="@ValueTypo"
                 Color="@ValueColor"
                 Style="@ValueStyle">
            @if (EnableCountAnimation && _isVisible)
            {
                <span class="count-value">@_displayValue</span>
            }
            else
            {
                @Value
            }
            @if (!string.IsNullOrEmpty(Unit))
            {
                <span class="statistic-unit">@Unit</span>
            }
        </MudText>

        @if (ShowTrend && Trend != TrendDirection.None)
        {
            <span class="trend-indicator @GetTrendClass()">
                @if (Trend == TrendDirection.Up)
                {
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Small" />
                    @if (!string.IsNullOrEmpty(TrendValue))
                    {
                        <span class="trend-value">@TrendValue</span>
                    }
                }
                else if (Trend == TrendDirection.Down)
                {
                    <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Size="Size.Small" />
                    @if (!string.IsNullOrEmpty(TrendValue))
                    {
                        <span class="trend-value">@TrendValue</span>
                    }
                }
            </span>
        }
    </div>

    @if (ChildContent != null)
    {
        @ChildContent
    }
</div>

@code {
    /// <summary>
    /// 标签文本
    /// </summary>
    [Parameter]
    public string Label { get; set; } = string.Empty;

    /// <summary>
    /// 数值
    /// </summary>
    [Parameter]
    public string Value { get; set; } = "0";

    /// <summary>
    /// 单位
    /// </summary>
    [Parameter]
    public string Unit { get; set; } = string.Empty;

    /// <summary>
    /// 标签样式
    /// </summary>
    [Parameter]
    public Typo LabelTypo { get; set; } = Typo.button;

    /// <summary>
    /// 标签颜色
    /// </summary>
    [Parameter]
    public Color LabelColor { get; set; } = Color.Default;

    /// <summary>
    /// 标签CSS类
    /// </summary>
    [Parameter]
    public string LabelClass { get; set; } = string.Empty;

    /// <summary>
    /// 数值样式
    /// </summary>
    [Parameter]
    public Typo ValueTypo { get; set; } = Typo.h6;

    /// <summary>
    /// 数值颜色
    /// </summary>
    [Parameter]
    public Color ValueColor { get; set; } = Color.Primary;

    /// <summary>
    /// 数值CSS类
    /// </summary>
    [Parameter]
    public string ValueClass { get; set; } = "fw-bold";

    /// <summary>
    /// 数值自定义样式
    /// </summary>
    [Parameter]
    public string ValueStyle { get; set; } = string.Empty;

    /// <summary>
    /// 容器对齐方式
    /// </summary>
    [Parameter]
    public string TextAlign { get; set; } = "center";

    /// <summary>
    /// 容器宽度
    /// </summary>
    [Parameter]
    public string? Width { get; set; }

    /// <summary>
    /// 启用数字滚动动画
    /// </summary>
    [Parameter]
    public bool EnableCountAnimation { get; set; } = true;

    /// <summary>
    /// 动画延迟索引（用于依次出现效果）
    /// </summary>
    [Parameter]
    public int AnimationDelay { get; set; } = 0;

    /// <summary>
    /// 显示趋势指示
    /// </summary>
    [Parameter]
    public bool ShowTrend { get; set; } = false;

    /// <summary>
    /// 趋势方向
    /// </summary>
    [Parameter]
    public TrendDirection Trend { get; set; } = TrendDirection.None;

    /// <summary>
    /// 趋势数值（如 "+5%"）
    /// </summary>
    [Parameter]
    public string TrendValue { get; set; } = string.Empty;

    /// <summary>
    /// 启用悬浮效果
    /// </summary>
    [Parameter]
    public bool EnableHover { get; set; } = true;

    /// <summary>
    /// 自定义内容
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private string _displayValue = "0";
    private bool _isVisible = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && EnableCountAnimation)
        {
            _isVisible = true;
            await AnimateCountAsync();
        }
    }

    private async Task AnimateCountAsync()
    {
        if (!double.TryParse(Value.Replace(",", ""), out double targetValue))
        {
            _displayValue = Value;
            StateHasChanged();
            return;
        }

        var duration = 600; // 毫秒
        var steps = 20;
        var stepDuration = duration / steps;
        var increment = targetValue / steps;

        for (int i = 1; i <= steps; i++)
        {
            var currentValue = increment * i;
            if (i == steps)
            {
                currentValue = targetValue;
            }

            // 保持原始格式
            if (Value.Contains("."))
            {
                var decimalPlaces = Value.Split('.').Last().Length;
                _displayValue = currentValue.ToString($"F{decimalPlaces}");
            }
            else if (Value.Contains(","))
            {
                _displayValue = currentValue.ToString("N0");
            }
            else
            {
                _displayValue = ((int)currentValue).ToString();
            }

            StateHasChanged();
            await Task.Delay(stepDuration);
        }
    }

    private string GetContainerStyle()
    {
        var styles = new List<string>
        {
            $"text-align:{TextAlign}",
            "display:flex",
            "flex-direction:column",
            "justify-content:center"
        };

        if (!string.IsNullOrEmpty(Width))
        {
            styles.Add($"width:{Width}");
        }

        if (AnimationDelay > 0)
        {
            styles.Add($"animation-delay:{AnimationDelay * 100}ms");
        }

        return string.Join("; ", styles);
    }

    private string GetAnimationClass()
    {
        var classes = new List<string> { "number-grow" };

        if (EnableHover)
        {
            classes.Add("hover-lift");
        }

        if (AnimationDelay > 0 && AnimationDelay <= 8)
        {
            classes.Add($"stagger-{AnimationDelay}");
        }

        return string.Join(" ", classes);
    }

    private string GetValueClasses()
    {
        return $"{ValueClass} statistic-number";
    }

    private string GetTrendClass()
    {
        return Trend switch
        {
            TrendDirection.Up => "trend-up arrow-up-anim",
            TrendDirection.Down => "trend-down arrow-down-anim",
            _ => ""
        };
    }

    public enum TrendDirection
    {
        None,
        Up,
        Down
    }
}

