@using MudBlazor

<div class="bioo-chart" style="width:100%">
    @if (!string.IsNullOrWhiteSpace(Title))
    {
        <MudText Typo="Typo.subtitle2" Class="mb-2">@Title</MudText>
    }

    @if (ChartData != null && ChartData.Length > 0 && ChartData[0] != null && ChartData[0].Length > 0)
    {
        <div class="bioo-chart__viewport" style="height:@Height">
            <MudChart ChartType="@ChartType"
                      ChartSeries="@MudChartSeries"
                      Labels="@Labels.ToArray()"
                      XAxisLabels="@Labels.ToArray()"
                      Width="100%"
                      Height="100%"
                      Class="bioo-chart__surface"
                      ChartOptions="@BuildChartOptions()" />
        </div>
    }
    else
    {
        <div style="text-align:center;padding:60px 0">
            <MudText Typo="Typo.body2" Color="Color.Secondary">暂无数据</MudText>
        </div>
    }
</div>

@code {
    [Parameter] public string? Title { get; set; }
    [Parameter] public ChartType ChartType { get; set; } = ChartType.Bar;
    [Parameter] public IReadOnlyList<string> Labels { get; set; } = Array.Empty<string>();
    [Parameter] public IReadOnlyList<ChartSeriesData> Series { get; set; } = Array.Empty<ChartSeriesData>();
    [Parameter] public ChartOptions Options { get; set; } = new();
    [Parameter] public string Height { get; set; } = "300px";

    private double[][] ChartData => Series.Select(s => s.Values.Select(v => (double)v).ToArray()).ToArray();

    private List<ChartSeries> MudChartSeries => Series.Select(s => new ChartSeries
    {
        Name = s.Label,
        Data = s.Values.Select(v => (double)v).ToArray()
    }).ToList();

    private MudBlazor.ChartOptions BuildChartOptions()
    {
        var computed = new MudBlazor.ChartOptions
        {
            YAxisTicks = Options?.YAxisTicks ?? 10,
            MaxNumYAxisTicks = Options?.MaxNumYAxisTicks ?? 10,
            YAxisLines = Options?.YAxisLines ?? true,
            XAxisLines = Options?.XAxisLines ?? false,
            ShowLegend = Options?.ShowLegend ?? true
        };

        if (!string.IsNullOrWhiteSpace(Options?.YAxisFormat))
        {
            computed.YAxisFormat = Options!.YAxisFormat;
        }

        if (Options?.YAxisRequireZeroPoint is bool requireZeroPoint)
        {
            computed.YAxisRequireZeroPoint = requireZeroPoint;
        }

        if (Options?.InterpolationOption is InterpolationOption interpolationOption)
        {
            computed.InterpolationOption = interpolationOption;
        }

        if (Options?.LineStrokeWidth is double lineWidth)
        {
            computed.LineStrokeWidth = lineWidth;
        }

        if (Options?.ChartPalette is { Length: > 0 } palette)
        {
            computed.ChartPalette = palette;
        }

        if (Options?.ShowLegendLabels is bool showLegendLabels)
        {
            computed.ShowLegendLabels = showLegendLabels;
        }

        if (Options?.ShowToolTips is bool showToolTips)
        {
            computed.ShowToolTips = showToolTips;
        }

        return computed;
    }

    public sealed record ChartSeriesData(string Label, IReadOnlyList<double> Values);

    public sealed record ChartOptions
    {
        public bool? ShowLegend { get; init; }
        public int? YAxisTicks { get; init; }
        public int? MaxNumYAxisTicks { get; init; }
        public string? YAxisFormat { get; init; }
        public bool? YAxisLines { get; init; }
        public bool? XAxisLines { get; init; }
        public bool? YAxisRequireZeroPoint { get; init; }
        public double? LineStrokeWidth { get; init; }
        public InterpolationOption? InterpolationOption { get; init; }
        public string[]? ChartPalette { get; init; }
        public bool? ShowLegendLabels { get; init; }
        public bool? ShowToolTips { get; init; }
    }
}
