@page "/"
@using Microsoft.EntityFrameworkCore
@using FollowUp.Services
@inject IUserContextService inj_userContextService
@inject ILogger<Home> inj_logger
@inject IHttpContextAccessor inj_httpContextAccessor
@inject NavigationManager inj_navigationManager
@attribute [AllowAnonymous]

<PageTitle>FollowUp 随访管理系统</PageTitle>

<div class="d-flex justify-center align-center" style="height: 100vh;">
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        try
        {
            inj_logger.LogInformation("Home 页面初始化开始");

            // 获取用户认证状态
            var user = inj_httpContextAccessor.HttpContext?.User;
            if (user?.Identity?.IsAuthenticated != true)
            {
                inj_logger.LogWarning("用户未认证，跳转到登录页");
                inj_navigationManager.NavigateTo("/login", true);
                return;
            }

            // 获取用户角色列表
            var roles = user.FindAll("roleName")
                .Select(c => System.Text.RegularExpressions.Regex.Unescape(c.Value))
                .ToList();

            inj_logger.LogInformation("用户角色: {Roles}", string.Join(", ", roles));

            if (roles.Count == 0)
            {
                inj_logger.LogWarning("用户无角色信息，跳转到登录页");
                inj_navigationManager.NavigateTo("/login", true);
                return;
            }

            // 角色路由优先级：医院管理员 > 科室管理员 > 课题管理员 > 随访角色 > 系统管理员
            // 医院、科室、课题管理员使用精确匹配
            if (roles.Contains("医院管理员"))
            {
                var hospitalId = await inj_userContextService.GetHospitalIdAsync();
                if (hospitalId.HasValue)
                {
                    inj_logger.LogInformation("医院管理员跳转到 /hospitalMain?hospitalId={HospitalId}", hospitalId.Value);
                    inj_navigationManager.NavigateTo($"/hospitalMain?hospitalId={hospitalId.Value}", true);
                }
                else
                {
                    // 医院管理员但没有医院信息，显示错误页面
                    inj_logger.LogError("医院管理员无医院信息");
                    inj_navigationManager.NavigateTo("/error?message=您暂无医院权限，请联系系统管理员分配权限", true);
                }
            }
            else if (roles.Contains("科室管理员"))
            {
                var department = await inj_userContextService.GetDepartmentAsync();
                if (department != null)
                {
                    inj_logger.LogInformation("科室管理员跳转到 /departmentMain");
                    inj_navigationManager.NavigateTo($"/departmentMain?departmentId={department.id}", true);
                }
                else
                {
                    // 科室管理员但没有科室信息，显示错误页面
                    inj_logger.LogError("科室管理员无科室信息");
                    inj_navigationManager.NavigateTo("/error?message=您暂无科室权限，请联系系统管理员分配权限", true);
                }
            }
            else if (roles.Contains("课题管理员"))
            {
                var project = await inj_userContextService.GetProjectAsync();
                if (project != null)
                {
                    inj_logger.LogInformation("课题管理员跳转到 /projectMain");
                    inj_navigationManager.NavigateTo($"/projectMain?projectId={project.id}", true);
                }
                else
                {
                    // 课题管理员但没有课题信息，显示错误页面
                    inj_logger.LogError("课题管理员无课题信息");
                    inj_navigationManager.NavigateTo("/error?message=您暂无课题权限，请联系系统管理员分配权限", true);
                }
            }
            // 随访和系统角色使用 Contains 模糊匹配（因为可能有多个随访角色）
            else if (roles.Any(r => r.Contains("随访")))
            {
                inj_logger.LogInformation("随访角色跳转到 /followupTaskManager/PendingReview");
                // TODO: [任务管理页面] - 实现任务管理页面后启用
                inj_navigationManager.NavigateTo("/followupTaskManager/PendingReview", true);
            }
            else if (roles.Any(r => r.Contains("系统")))
            {
                inj_logger.LogInformation("系统管理员跳转到 /adminMain");
                inj_navigationManager.NavigateTo("/adminMain", true);
            }
            else
            {
                inj_logger.LogInformation("默认跳转到 /followupTaskManager/PendingReview");
                // 默认跳转到任务管理
                // TODO: [任务管理页面] - 实现任务管理页面后启用
                inj_navigationManager.NavigateTo("/followupTaskManager/PendingReview", true);
            }
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "角色路由失败");
            inj_navigationManager.NavigateTo("/login", true);
        }
    }
}

