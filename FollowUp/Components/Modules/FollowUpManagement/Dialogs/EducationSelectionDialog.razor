@namespace FollowUp.Components.Modules.FollowUpManagement.Dialogs
@inherits BasePage

<MudDialog Class="education-selection-dialog">
    <DialogContent>
        <MudText Typo="Typo.h6" Class="mb-3">选择宣教内容</MudText>
        <MudSelect T="Guid?"
                   @bind-Value="_selectedEducationId"
                   Label="宣教模板"
                   Variant="Variant.Filled"
                   Dense="true"
                   Class="full-width">
            @if (_educationOptions.Count == 0)
            {
                <MudSelectItem Value="@((Guid?)null)">暂无可选宣教</MudSelectItem>
            }
            else
            {
                @foreach (var item in _educationOptions)
                {
                    <MudSelectItem Value="@( (Guid?)item.Id )">@item.Title</MudSelectItem>
                }
            }
        </MudSelect>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="Cancel">取消</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Disabled="_educationOptions.Count == 0"
                   OnClick="Confirm">
            确认
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Guid ProjectId { get; set; }

    [Parameter]
    public Guid? InitialEducationId { get; set; }

    private readonly List<EducationOption> _educationOptions = new();
    private Guid? _selectedEducationId;

    protected override async Task OnPageInitializedAsync()
    {
        await base.OnPageInitializedAsync();
        await LoadOptionsAsync();
    }

    private async Task LoadOptionsAsync()
    {
        try
        {
            await using var context = await ContextFactory.CreateDbContextAsync();

        var raw = await context.followup_education
            .AsNoTracking()
            .OrderByDescending(e => e.create_time)
            .Select(e => new
            {
                e.id,
                e.title,
                e.project_id
            })
            .ToListAsync();

        var options = ProjectId == Guid.Empty
            ? raw
            : raw.Where(e => e.project_id != null && e.project_id.Contains(ProjectId));

            _educationOptions.Clear();
            _educationOptions.AddRange(options.Select(e => new EducationOption
            {
                Id = e.id,
                Title = string.IsNullOrWhiteSpace(e.title) ? "未命名宣教" : e.title
            }));
            _selectedEducationId = InitialEducationId != Guid.Empty ? InitialEducationId : null;
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(ex, "加载宣教列表失败", "查询宣教内容");
        }
    }

    private void Confirm()
    {
        MudDialog.Close(MudDialogResult.Ok(_selectedEducationId));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private sealed class EducationOption
    {
        public Guid Id { get; set; }
        public string Title { get; set; } = string.Empty;
    }
}
