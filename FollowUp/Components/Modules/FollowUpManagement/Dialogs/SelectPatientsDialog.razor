@namespace FollowUp.Components.Modules.FollowUpManagement.Dialogs
@using FollowUp.Components.Modules.FollowUpManagement.Models
@inherits BasePage

<MudDialog Class="select-patients-dialog">
    <TitleContent>
        <MudText Typo="Typo.h6">选择患者</MudText>
    </TitleContent>
    <DialogContent>
        <MudStack Spacing="8">
            <MudTextField @bind-Value="_keyword"
                          Label="姓名/病案号/手机号"
                          Variant="Variant.Outlined"
                          Immediate="true"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Rounded.Search"
                          OnKeyDown="HandleEnter" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="Search">搜索</MudButton>

            <MudTable Items="_patients"
                      Dense="true"
                      Hover="true"
                      MultiSelection="true"
                      SelectedItemsChanged="@( (HashSet<PatientSearchDto> selected) => OnSelectedItemsChanged(selected) )"
                      RowCheckBoxVisible="true"
                      SelectedItems="_selectedPatients">
                <HeaderContent>
                    <MudTh>姓名</MudTh>
                    <MudTh>病案号</MudTh>
                    <MudTh>手机号</MudTh>
                    <MudTh>身份证号</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="姓名">@context.Name</MudTd>
                    <MudTd DataLabel="病案号">@context.MedicalRecordNumber</MudTd>
                    <MudTd DataLabel="手机号">@context.PhoneNumber</MudTd>
                    <MudTd DataLabel="身份证号">@context.IdCard</MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <EmptyDataView Message="暂无数据，请输入关键词搜索" />
                </NoRecordsContent>
            </MudTable>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">取消</MudButton>
        <MudButton OnClick="Confirm" Variant="Variant.Filled" Color="Color.Primary" Disabled="@(!_selectedPatients.Any())">
            确定
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public Guid ProjectId { get; set; }

    [Parameter]
    public IReadOnlyCollection<PatientSearchDto> InitialSelectedPatients { get; set; } = Array.Empty<PatientSearchDto>();

    [Inject] private Services.TaskCreationService _creationService { get; set; } = default!;

    private string _keyword = string.Empty;
    private List<PatientSearchDto> _patients = new();
    private HashSet<PatientSearchDto> _selectedPatients = new();

    protected override void OnInitialized()
    {
        if (InitialSelectedPatients.Any())
        {
            _selectedPatients = InitialSelectedPatients.ToHashSet();
            _patients = InitialSelectedPatients.ToList();
        }
    }

    private async Task Search()
    {
        if (string.IsNullOrWhiteSpace(_keyword) || _keyword.Length < 2)
        {
            inj_snackbar.Add("请输入至少 2 个字符进行搜索", Severity.Info);
            return;
        }

        try
        {
            _patients = await _creationService.SearchPatientsAsync(_keyword, ProjectId);
        }
        catch (Exception ex)
        {
            await HandleExceptionAsync(ex, "搜索患者失败", "搜索患者");
        }
    }

    private void OnSelectedItemsChanged(HashSet<PatientSearchDto> selected)
    {
        _selectedPatients = selected;
    }

    private async Task HandleEnter(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            await Search();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void Confirm()
    {
        MudDialog.Close(MudDialogResult.Ok(_selectedPatients.ToList()));
    }
}
