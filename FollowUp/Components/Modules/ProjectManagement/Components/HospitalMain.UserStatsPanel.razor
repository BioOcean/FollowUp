@namespace FollowUp.Components.Modules.ProjectManagement.Components
@inherits BasePage
@implements IDisposable

<MudPaper Elevation="1" Class="user-stats-card">
    <div class="d-flex align-items-center pa-2 justify-content-between">
        <div class="d-flex align-items-center">
            <MudText Class="fw-bold" Typo="Typo.h6">平台用户数据</MudText>
        </div>
        <div class="d-flex">
            <RadioList IsButton="true" TValue="string" Items="@filterSelectList" @bind-Value="selectedFilter" Color="BColor.Success" class="mr-3" OnSelectedChanged="@OnFilterChanged"></RadioList>
            @if (selectedFilter == "年度数据")
            {
                <DateTimePicker @bind-Value="yearValue" ViewMode="DatePickerViewMode.Year" DateFormat="yyyy" class="mb-0" OnValueChanged="@OnYearValueChanged" />
            }
        </div>
    </div>

    @if (isLoading)
    {
        <MudSkeleton Height="400px" Animation="Animation.Wave" />
    }
    else
    {
        <div class="d-flex p-2">
            <MudPaper Class="p-2" Elevation="0" Style="width:40%;">
                <div class="d-flex align-items-center justify-content-between mb-2" style="text-align:center;min-height:56px;">
                    <div>
                        <MudText Typo="Typo.button">累计扫码上平台数量</MudText>
                        <p style="color:var(--primary-color);" class="fs-5 mb-0">@(currentStats?.TotalPatients ?? 0)</p>
                    </div>
                    <div>
                        <MudText Typo="Typo.button">随访次数</MudText>
                        <p style="color:var(--primary-color);" class="fs-6 mb-0">@(currentStats?.TotalFollowupTasks ?? 0)</p>
                    </div>
                    <div>
                        <MudText Typo="Typo.button" Class="ml-4">随访人数</MudText>
                        <p style="color:var(--primary-color);" class="fs-6 mb-0">@(currentStats?.TotalFollowupPatients ?? 0)</p>
                    </div>
                </div>

                @if (isShowAgeChart)
                {
                    <FollowUp.Components.Shared.Charts.BiooChartsLegacy Width="100%" Height="300px" ChartType="BChartType.Pie" TitleLabels="@ageChartLabels" ChartOptions="@ageChartOptions" Items="@ageChartData" @key="@($"age-{chartRenderKey}")" />
                }
                else
                {
                    <EmptyDataView Padding="60px 0" Message="无数据" />
                }
            </MudPaper>

            <MudDivider Vertical="true" FlexItem="true" Light="true"/>

            <MudPaper Class="p-2" Elevation="0" Style="width:30%;">
                <div class="d-flex justify-content-between mb-2" style="min-height:56px;align-items:flex-start;">
                    <MudText Typo="Typo.button">@("患者数量：" + (currentStats?.TotalPatients ?? 0) + "人")</MudText>
                    <MudText Typo="Typo.button">@("科室数量：" + DepartmentList.Count)</MudText>
                </div>
                @if (isShowDepartmentChart)
                {
                    <FollowUp.Components.Shared.Charts.BiooChartsLegacy Width="100%" Height="300px" ChartType="BChartType.Doughnut" TitleLabels="@departmentChartLabels" ChartOptions="@departmentChartOptions" Items="@departmentChartData" @key="@($"dept-{chartRenderKey}")" />
                }
                else
                {
                    <EmptyDataView Padding="60px 0" Message="无数据" />
                }
            </MudPaper>

            <MudDivider Vertical="true" FlexItem="true" Light="true"/>

            <MudPaper Class="p-2" Elevation="0" Style="width:30%;">
                <div style="min-height:56px;display:flex;align-items:flex-start;margin-bottom:8px;">
                    <MudText Typo="Typo.button">@("今日新增患者：" + (currentStats?.TodayNewPatients ?? 0) + "人")</MudText>
                </div>
                @if (isShowTodayChart)
                {
                    <FollowUp.Components.Shared.Charts.BiooChartsLegacy Width="100%" Height="300px" ChartType="BChartType.Doughnut" TitleLabels="@todayChartLabels" ChartOptions="@todayChartOptions" Items="@todayChartData" @key="@($"today-{chartRenderKey}")" />
                }
                else
                {
                    <EmptyDataView Padding="60px 0" Message="无数据" />
                }
            </MudPaper>
        </div>
    }
</MudPaper>

@code {
    private ILogger<HospitalMain_UserStatsPanel> inj_logger => inj_loggerFactory.CreateLogger<HospitalMain_UserStatsPanel>();
    [Parameter] public Guid HospitalId { get; set; }
    [Parameter] public List<sys_department> DepartmentList { get; set; } = new();
    [Parameter] public IReadOnlyList<DepartmentProjectMap> DepartmentProjects { get; set; } = Array.Empty<DepartmentProjectMap>();

    private List<SelectedItem> filterSelectList = new();
    private string selectedFilter = "全部";
    private DateTime yearValue = DateTime.Now;
    private bool isLoading = false;
    private HospitalUserStatsDto? currentStats;
    private List<int> yearOptions = new();

    // 图表数据
    private BChartOptions ageChartOptions = new();
    private List<string> ageChartLabels = new();
    private List<ChartDataset> ageChartData = new();
    private bool isShowAgeChart = false;

    private BChartOptions departmentChartOptions = new();
    private List<string> departmentChartLabels = new();
    private List<ChartDataset> departmentChartData = new();
    private bool isShowDepartmentChart = false;

    private BChartOptions todayChartOptions = new();
    private List<string> todayChartLabels = new();
    private List<ChartDataset> todayChartData = new();
    private bool isShowTodayChart = false;

    private int chartRenderKey = 0;

    private CancellationTokenSource? _loadCts;
    private int _requestSequence = 0;

    protected override async Task OnInitializedAsync()
    {
        filterSelectList = new List<SelectedItem>
        {
            new SelectedItem { Text = "全部", Value = "全部" },
            new SelectedItem { Text = "年度数据", Value = "年度数据" }
        };

        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadYearOptionsAsync();
        if (!yearOptions.Contains(yearValue.Year) && yearOptions.Any())
        {
            yearValue = new DateTime(yearOptions.First(), 1, 1);
        }
        await LoadStatsAsync();
    }

    private async Task OnFilterChanged(IEnumerable<SelectedItem> values, string value)
    {
        selectedFilter = value;
        await LoadStatsAsync();
    }

    private async Task OnYearValueChanged(DateTime dateTime)
    {
        yearValue = dateTime;
        if (selectedFilter == "年度数据")
        {
            await LoadStatsAsync();
        }
    }

    private async Task LoadStatsAsync()
    {
        if (HospitalId == Guid.Empty)
        {
            return;
        }

        // 取消之前的请求
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        _loadCts = new CancellationTokenSource();

        var currentSequence = ++_requestSequence;
        var cancellationToken = _loadCts.Token;

        try
        {
            isLoading = true;
            StateHasChanged();

            int? year = selectedFilter == "年度数据" ? yearValue.Year : null;
            currentStats = await inj_overviewStatisticsService.GetUserStatsAsync(
                HospitalId,
                DepartmentProjects,
                year,
                cancellationToken);

            // 只有当前请求是最新的才更新UI
            if (currentSequence == _requestSequence && !cancellationToken.IsCancellationRequested)
            {
                UpdateChartData();
            }
        }
        catch (OperationCanceledException)
        {
            // 请求被取消，忽略
        }
        catch (Exception ex)
        {
            // 只有当前请求是最新的才处理错误
            if (currentSequence == _requestSequence)
            {
                inj_logger.LogError(ex, "加载用户统计数据失败");
                currentStats = null;
                UpdateChartData();
            }
        }
        finally
        {
            // 只有当前请求是最新的才更新加载状态
            if (currentSequence == _requestSequence)
            {
                isLoading = false;
                StateHasChanged();
            }
        }
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
    }

    private void UpdateChartData()
    {
        // 年龄分布图表
        ageChartOptions.ShowLegend = true;
        ageChartOptions.LegendPosition = ChartLegendPosition.Bottom;
        ageChartLabels = currentStats?.AgeLabels.ToList() ?? new List<string>();
        ageChartData = new List<ChartDataset>();
        isShowAgeChart = currentStats?.AgeValues.Any(v => v > 0) ?? false;

        if (isShowAgeChart && currentStats != null)
        {
            ageChartData.Add(new ChartDataset
            {
                Label = "年龄分布",
                Data = currentStats.AgeValues.Select(v => (object)v).ToArray()
            });
        }

        // 科室分布图表
        departmentChartOptions.ShowLegend = true;
        departmentChartOptions.LegendPosition = ChartLegendPosition.Bottom;
        departmentChartLabels = currentStats?.DepartmentLabels.ToList() ?? new List<string>();
        departmentChartData = new List<ChartDataset>();
        isShowDepartmentChart = currentStats?.DepartmentPatientValues.Any(v => v > 0) ?? false;

        if (isShowDepartmentChart && currentStats != null)
        {
            departmentChartData.Add(new ChartDataset
            {
                Label = "科室分布",
                Data = currentStats.DepartmentPatientValues.Select(v => (object)v).ToArray()
            });
        }

        // 今日新增图表
        todayChartOptions.ShowLegend = true;
        todayChartOptions.LegendPosition = ChartLegendPosition.Bottom;
        todayChartLabels = currentStats?.TodayLabels.ToList() ?? new List<string>();
        todayChartData = new List<ChartDataset>();
        isShowTodayChart = currentStats?.TodayPatientValues.Any(v => v > 0) ?? false;

        if (isShowTodayChart && currentStats != null)
        {
            todayChartData.Add(new ChartDataset
            {
                Label = "今日新增",
                Data = currentStats.TodayPatientValues.Select(v => (object)v).ToArray()
            });
        }

        chartRenderKey++;
    }

    private async Task LoadYearOptionsAsync()
    {
        try
        {
            await using var context = await ContextFactory.CreateDbContextAsync();

            var patientYears = await context.patient.AsNoTracking()
                .Where(p => p.hospital_id == HospitalId && p.create_time.HasValue)
                .Select(p => p.create_time!.Value.Year)
                .Distinct()
                .ToListAsync();

            var projectIds = DepartmentProjects.SelectMany(d => d.ProjectIds)
                .Where(id => id != Guid.Empty)
                .Distinct()
                .ToList();

            var followupYears = new List<int>();
            if (projectIds.Any())
            {
                followupYears = await context.patient_event.AsNoTracking()
                    .Where(pe => projectIds.Contains(pe.project_id) && pe.push_time.HasValue)
                    .Select(pe => pe.push_time!.Value.Year)
                    .Distinct()
                    .ToListAsync();
            }

            yearOptions = patientYears
                .Concat(followupYears)
                .Where(y => y > 0)
                .Distinct()
                .OrderByDescending(y => y)
                .ToList();

            if (!yearOptions.Any())
            {
                var nowYear = DateTime.Now.Year;
                yearOptions = Enumerable.Range(nowYear - 5, 6).Reverse().ToList();
            }
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "加载平台用户数据年份列表失败");
            var nowYear = DateTime.Now.Year;
            yearOptions = Enumerable.Range(nowYear - 5, 6).Reverse().ToList();
        }
    }
}
