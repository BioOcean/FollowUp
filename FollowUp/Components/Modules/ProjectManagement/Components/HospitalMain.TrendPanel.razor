@namespace FollowUp.Components.Modules.ProjectManagement.Components
@inherits BasePage
@inject ILogger<HospitalMain_TrendPanel> inj_logger
@inject IHospitalStatisticsService inj_statisticsService

@* 随访率/宣教阅读率趋势 *@
<MudPaper Elevation="1" Class="mt-3 p-2 trend-panel" Height="350px">
    <div class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <RadioList IsButton="true" TValue="string" Items="@modeSelectList" @bind-Value="selectedMode" Color="BColor.Success" OnSelectedChanged="@OnModeChanged"></RadioList>
        </div>
        <div class="d-flex align-items-center">
            <DateTimePicker @bind-Value="yearValue" ViewMode="DatePickerViewMode.Year" DateFormat="yyyy" class="mb-0" OnValueChanged="@OnYearValueChanged" />
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center align-items-center" style="height:300px">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Class="ml-3">正在加载数据...</MudText>
        </div>
    }
    else if (isShowChart)
    {
        <FollowUp.Components.Shared.Charts.BiooChartsLegacy Width="100%" Height="300px" ChartType="BChartType.Line" TitleLabels="@monthLabels" ChartOptions="@chartOptions" Items="@chartDatasets" @key="@chartRenderKey" />
    }
    else
    {
        <div style="text-align:center" class="mt-10">
            <MudImage Src="images/nodata.jpg" Style="width:120px" />
            <MudText Class="mt-2">无数据</MudText>
        </div>
    }
</MudPaper>

@code {
    [Parameter] public Guid HospitalId { get; set; }

    private List<SelectedItem> modeSelectList = new();
    private string selectedMode = "随访率";
    private DateTime yearValue = DateTime.Now;
    private bool isLoading = false;

    private List<string> monthLabels = new List<string> { "1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月" };

    private BChartOptions chartOptions = new();
    private List<ChartDataset> chartDatasets = new List<ChartDataset>();
    private bool isShowChart = false;
    private int chartRenderKey = 0;

    protected override async Task OnInitializedAsync()
    {
        modeSelectList = new List<SelectedItem>
        {
            new SelectedItem { Text = "随访率", Value = "随访率" },
            new SelectedItem { Text = "宣教阅读率", Value = "宣教阅读率" }
        };

        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadDataAsync();
    }

    private async Task OnModeChanged(IEnumerable<SelectedItem> values, string value)
    {
        selectedMode = value;
        await LoadDataAsync();
    }

    private async Task OnYearValueChanged(DateTime dateTime)
    {
        yearValue = dateTime;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            List<double> monthlyRates;
            if (selectedMode == "随访率")
            {
                var trend = await inj_statisticsService.GetFollowupTrendAsync(HospitalId, yearValue.Year);
                monthlyRates = trend.MonthlyRates.ToList();
            }
            else
            {
                var trend = await inj_statisticsService.GetEducationTrendAsync(HospitalId, yearValue.Year);
                monthlyRates = trend.MonthlyRates.ToList();
            }

            UpdateChartData(monthlyRates);
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "加载趋势数据失败");
            UpdateChartData(new List<double>());
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void UpdateChartData(List<double> monthlyRates)
    {
        chartOptions.LegendPosition = ChartLegendPosition.Bottom;
        chartOptions.ShowLegend = false;
        chartDatasets = new List<ChartDataset>();

        isShowChart = !monthlyRates.All(a => a == 0);

        if (isShowChart)
        {
            string label = selectedMode == "随访率" ? "随访率(%)" : "阅读率(%)";
            chartDatasets.Add(new ChartDataset
            {
                Label = label,
                Data = monthlyRates.Cast<object>().ToArray(),
            });
        }

        chartRenderKey++;
    }
}

