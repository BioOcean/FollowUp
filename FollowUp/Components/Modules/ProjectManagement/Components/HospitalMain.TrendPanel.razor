@namespace FollowUp.Components.Modules.ProjectManagement.Components
@inherits BasePage
@implements IDisposable

@* 随访率/宣教阅读率趋势 *@
<MudPaper Elevation="1" Class="mt-3 trend-panel">
    <div class="trend-panel-header">
        <div class="d-flex align-items-center">
            <RadioList IsButton="true" TValue="string" Items="@modeSelectList" @bind-Value="selectedMode" Color="BColor.Success" OnSelectedChanged="@OnModeChanged"></RadioList>
        </div>
        <div class="d-flex align-items-center">
            <DateTimePicker @bind-Value="yearValue" ViewMode="DatePickerViewMode.Year" DateFormat="yyyy" class="mb-0" OnValueChanged="@OnYearValueChanged" />
        </div>
    </div>

    <div class="trend-panel-body">
        @if (isLoading)
        {
            <LoadingView Height="260px" />
        }
        else if (isShowChart)
        {
            <FollowUp.Components.Shared.Charts.BiooChartsLegacy Width="100%" Height="260px" ChartType="BChartType.Line" TitleLabels="@monthLabels" ChartOptions="@chartOptions" Items="@chartDatasets" @key="@chartRenderKey" />
        }
        else
        {
            <EmptyDataView Padding="80px 0" Message="无数据" ImageSize="100px" />
        }
    </div>
</MudPaper>

@code {
    [Parameter] public Guid HospitalId { get; set; }
    [Parameter] public Guid? DepartmentId { get; set; }
    [Parameter] public Guid? ProjectId { get; set; }
    [Parameter] public IReadOnlyCollection<Guid>? ProjectIds { get; set; }

    private ILogger<HospitalMain_TrendPanel> inj_logger => inj_loggerFactory.CreateLogger<HospitalMain_TrendPanel>();

    private readonly List<SelectedItem> modeSelectList = new()
    {
        new() { Text = "随访率", Value = "随访率" },
        new() { Text = "宣教阅读率", Value = "宣教阅读率" }
    };

    private readonly List<string> monthLabels = new() { "1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月" };

    private string selectedMode = "随访率";
    private DateTime yearValue = DateTime.Now;
    private bool isLoading = false;
    private bool isShowChart = false;
    private int chartRenderKey = 0;

    private readonly BChartOptions chartOptions = new() { LegendPosition = ChartLegendPosition.Bottom, ShowLegend = false };
    private List<ChartDataset> chartDatasets = new();

    private CancellationTokenSource? _loadCts;
    private int _requestSequence = 0;

    protected override async Task OnParametersSetAsync() => await LoadDataAsync();

    private async Task OnModeChanged(IEnumerable<SelectedItem> values, string value)
    {
        selectedMode = value;
        await LoadDataAsync();
    }

    private async Task OnYearValueChanged(DateTime dateTime)
    {
        yearValue = dateTime;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
        _loadCts = new CancellationTokenSource();

        var currentSequence = ++_requestSequence;
        var cancellationToken = _loadCts.Token;

        try
        {
            isLoading = true;
            StateHasChanged();

            var monthlyRates = selectedMode == "随访率"
                ? await LoadFollowupRatesAsync(cancellationToken)
                : await LoadEducationRatesAsync(cancellationToken);

            if (currentSequence == _requestSequence && !cancellationToken.IsCancellationRequested)
            {
                UpdateChartData(monthlyRates);
            }
        }
        catch (OperationCanceledException) { }
        catch (Exception ex)
        {
            if (currentSequence == _requestSequence)
            {
                inj_logger.LogError(ex, "加载趋势数据失败");
                UpdateChartData(new List<double>());
            }
        }
        finally
        {
            if (currentSequence == _requestSequence)
            {
                isLoading = false;
                StateHasChanged();
            }
        }
    }

    private async Task<List<double>> LoadFollowupRatesAsync(CancellationToken cancellationToken)
    {
        IReadOnlyCollection<Guid>? effectiveProjectIds = ProjectId.HasValue
            ? new[] { ProjectId.Value }
            : (ProjectIds != null && ProjectIds.Any() ? ProjectIds : null);

        var trend = await inj_followupStatisticsService.GetFollowupTrendAsync(
            HospitalId, yearValue.Year, effectiveProjectIds, cancellationToken);

        return trend.MonthlyRates.ToList();
    }

    private async Task<List<double>> LoadEducationRatesAsync(CancellationToken cancellationToken)
    {
        IReadOnlyCollection<Guid>? effectiveProjectIds = null;
        Guid? effectiveDepartmentId = null;

        if (ProjectId.HasValue)
        {
            effectiveProjectIds = new[] { ProjectId.Value };
        }
        else if (DepartmentId.HasValue)
        {
            effectiveDepartmentId = DepartmentId.Value;
        }

        var trend = await inj_educationStatisticsService.GetEducationTrendAsync(
            HospitalId, yearValue.Year, effectiveDepartmentId, effectiveProjectIds, cancellationToken);

        return trend.MonthlyRates.ToList();
    }

    public void Dispose()
    {
        _loadCts?.Cancel();
        _loadCts?.Dispose();
    }

    private void UpdateChartData(List<double> monthlyRates)
    {
        isShowChart = monthlyRates.Any(r => r > 0);

        if (isShowChart)
        {
            var label = selectedMode == "随访率" ? "随访率(%)" : "阅读率(%)";
            chartDatasets = new List<ChartDataset>
            {
                new() { Label = label, Data = monthlyRates.Cast<object>().ToArray() }
            };
        }
        else
        {
            chartDatasets.Clear();
        }

        chartRenderKey++;
    }
}
