@namespace FollowUp.Components.Modules.ProjectManagement.Components
@inherits BasePage
@using FollowUp.Components.Shared.Charts

@* 活跃度情况 *@
<MudPaper Elevation="1" Class="mt-3 p-3 activity-panel">
    <div class="d-flex flex-column">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <MudText Class="fw-bold" Typo="Typo.h6">活跃度情况</MudText>
            </div>
            <div class="d-flex align-items-center">
                <RadioList IsButton="true" TValue="string" Items="@dimensionSelectList" @bind-Value="selectedDimensionStr" Color="BColor.Success" OnSelectedChanged="@OnDimensionChanged" class="mr-3"></RadioList>
                <DateTimePicker @bind-Value="selectedDateValue" ViewMode="@datePickerViewMode" DateFormat="@dateFormat" class="mb-0" OnValueChanged="@OnDateValueChanged" />
            </div>
        </div>

        @if (isLoading)
        {
            <LoadingView Height="400px" />
        }
        else if (hasData)
        {
            <CombinationChart BarSeriesData="@activeCounts.ToArray()"
                              LineSeriesData="@activePercents.ToArray()"
                              XAxisLabels="@labels.ToArray()"
                              BarSeriesName="活跃人数"
                              LineSeriesName="活跃占比(%)"
                              Options="@activityChartOptions" />
        }
        else
        {
            <EmptyDataView Padding="120px 0" Message="无数据" />
        }
    </div>
</MudPaper>

@code {
    [Parameter] public Guid HospitalId { get; set; }
    [Parameter] public IReadOnlyCollection<Guid>? ProjectIds { get; set; }

    private ILogger<HospitalMain_ActivityPanel> inj_logger => inj_loggerFactory.CreateLogger<HospitalMain_ActivityPanel>();

    private List<SelectedItem> dimensionSelectList = new();
    private string selectedDimensionStr = "日活";
    private ActivityDimension selectedDimension => selectedDimensionStr == "日活" ? ActivityDimension.Daily : ActivityDimension.Monthly;
    private DateTime selectedDateValue = DateTime.Now;
    private bool isLoading = false;

    private List<int> activeCounts = new();
    private List<int> activePercents = new();
    private List<string> labels = new();

    private bool hasData => activeCounts.Any(c => c > 0);

    private string dateFormat => selectedDimension == ActivityDimension.Daily ? "yyyy-MM" : "yyyy";
    private DatePickerViewMode datePickerViewMode => selectedDimension == ActivityDimension.Daily ? DatePickerViewMode.Month : DatePickerViewMode.Year;

    private readonly CustomChartOptions activityChartOptions = new()
    {
        ShowBarValues = true,
        ShowLineValues = true,
        ShowLegend = true,
        LegendPosition = LegendPosition.Bottom,
        PreserveAspectRatio = false,
        Width = 0,
        Height = 400,
        BarColor = "#2F855A",  // 深色医疗风 - 成功色
        LineColor = "#DD6B20"  // 深色医疗风 - 警告色
    };

    protected override async Task OnInitializedAsync()
    {
        dimensionSelectList = new List<SelectedItem>
        {
            new SelectedItem { Text = "日活", Value = "日活" },
            new SelectedItem { Text = "月活", Value = "月活" }
        };

        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadDataAsync();
    }

    private async Task OnDimensionChanged(IEnumerable<SelectedItem> values, string value)
    {
        selectedDimensionStr = value;
        await LoadDataAsync();
    }

    private async Task OnDateValueChanged(DateTime dateTime)
    {
        selectedDateValue = dateTime;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var stats = await inj_patientStatisticsService.GetActivityStatsAsync(
                HospitalId,
                selectedDimension,
                selectedDateValue,
                ProjectIds
            );

            activeCounts = stats.ActiveCounts.ToList();
            activePercents = stats.ActivePercents.ToList();
            labels = stats.Labels.ToList();
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "加载活跃度数据失败");
            activeCounts = new List<int>();
            activePercents = new List<int>();
            labels = new List<string>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
