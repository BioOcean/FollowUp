@page "/adminMain"
@using Microsoft.EntityFrameworkCore
@using FollowUp.Services.Extension
@using FollowUp.Constants
@inherits BasePage

<PageTitle>管理员主页</PageTitle>

<div class="admin-main-container">
    @if (isLoading)
    {
        <div class="loading-wrapper">
            <MudProgressCircular Color="Color.Success" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6" Color="Color.Primary" Class="mt-3">正在加载数据...</MudText>
        </div>
    }
    else if (!hasPermission)
    {
        <div class="empty-wrapper">
            <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Secondary" Style="font-size: 64px;" />
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-3">您没有访问此页面的权限</MudText>
        </div>
    }
    else if (hospitalProjects == null || !hospitalProjects.Any())
    {
        <div class="empty-wrapper">
            <MudIcon Icon="@Icons.Material.Filled.FolderOpen" Size="Size.Large" Color="Color.Secondary" Style="font-size: 64px;" />
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-3">暂无数据可显示</MudText>
        </div>
    }
    else
    {
        <MudGrid Spacing="4">
            @foreach (var item in hospitalProjects)
            {
                @if (item.hospitalId == Guid.Empty)
                {
                    <!-- 系统管理卡片 -->
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <div class="hospital-card system-card" @onclick="@(() => PageToHospital(item.hospitalId))">
                            <div class="hospital-card-header">
                                <div class="hospital-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.Settings" />
                                </div>
                                <MudText Typo="Typo.h6" Class="hospital-name">
                                    @item.hospitalName
                                </MudText>
                            </div>

                            <div class="hospital-card-body">
                                <div class="system-description">
                                    管理系统科室、用户权限、配置等全局功能
                                </div>
                            </div>

                            <div class="hospital-card-footer">
                                <MudText Typo="Typo.caption">点击进入管理</MudText>
                                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                            </div>
                        </div>
                    </MudItem>
                }
                else
                {
                    <!-- 医院卡片 -->
                    <MudItem xs="12" sm="6" md="4" lg="3">
                        <div class="hospital-card" @onclick="@(() => PageToHospital(item.hospitalId))">
                            <div class="hospital-card-header">
                                <div class="hospital-icon">
                                    <MudIcon Icon="@Icons.Material.Filled.LocalHospital" />
                                </div>
                                <MudText Typo="Typo.h6" Class="hospital-name">
                                    @item.hospitalName
                                </MudText>
                            </div>
                            
                            <div class="hospital-card-body">
                                <div class="stat-item">
                                    <MudText Typo="Typo.body2" Class="stat-label">
                                        <MudIcon Icon="@Icons.Material.Filled.Book" Class="stat-icon" />
                                        课题项目
                                    </MudText>
                                    <MudText Class="stat-value">@item.projects.Count</MudText>
                                </div>

                                <div class="stat-item">
                                    <MudText Typo="Typo.body2" Class="stat-label">
                                        <MudIcon Icon="@Icons.Material.Filled.People" Class="stat-icon" />
                                        患者人数
                                    </MudText>
                                    @if (!item.isStatisticsLoaded)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="stat-loading" />
                                    }
                                    else
                                    {
                                        <MudText Class="stat-value">@item.patientsNum</MudText>
                                    }
                                </div>

                                <div class="stat-item">
                                    <MudText Typo="Typo.body2" Class="stat-label">
                                        <MudIcon Icon="@Icons.Material.Filled.Assignment" Class="stat-icon" />
                                        随访任务
                                    </MudText>
                                    @if (!item.isStatisticsLoaded)
                                    {
                                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="stat-loading" />
                                    }
                                    else
                                    {
                                        <MudText Class="stat-value">@item.followupTasksNum</MudText>
                                    }
                                </div>
                            </div>
                            
                            <div class="hospital-card-footer">
                                <MudText Typo="Typo.caption">点击查看详情</MudText>
                                <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                            </div>
                        </div>
                    </MudItem>
                }
            }
        </MudGrid>
    }
</div>


@code {
    private ILogger<AdminMain> inj_logger => inj_loggerFactory.CreateLogger<AdminMain>();
    private List<HospitalProject> hospitalProjects = new();
    private bool isLoading = true;
    private bool hasPermission = false;

    protected override async Task OnPageInitializedAsync()
    {
        // AdminMain 是系统管理员的全局视图，不需要清除缓存
        // （NTCare 中清除缓存是为了重置"当前选择的医院/科室/课题"状态）
        // FollowUp 采用更简单的设计：全局视图不维护"当前选择"状态

        // 直接异步加载数据（Blazor 已在线程池中运行，无需 Task.Run）
        await LoadData();
    }

    /// <summary>
    /// 检查当前用户是否有系统管理员权限
    /// </summary>
    private Task<bool> CheckPermissionAsync()
    {
        try
        {
            // 使用统一的权限服务检查
            return Task.FromResult(inj_authService.IsSystemAdmin());
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "AdminMain 检查权限时发生错误");
            return Task.FromResult(false);
        }
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;

            hasPermission = await CheckPermissionAsync();

            if (!hasPermission)
            {
                inj_logger.LogWarning("用户访问 AdminMain 页面权限不足");
                isLoading = false;
                return;
            }

            // 性能优化：分步加载，先显示基本信息，再加载统计数据
            // 第一步：快速加载医院基本信息和课题项目
            var basicHospitalInfo = await _context.form_form_set!
                .Where(s => s.type == "followup")
                .Include(s => s.hospital)
                .Include(s => s.project)
                .Where(s => s.hospital != null)
                .GroupBy(s => new { s.hospital_id, s.hospital!.name })
                .Select(g => new HospitalProject
                {
                    hospitalId = g.Key.hospital_id,
                    hospitalName = g.Key.name ?? "",
                    projects = g.Select(s => s.project).Distinct().ToList(),
                    patientsNum = 0, // 暂时为0，后续异步加载
                    followupTasksNum = 0 // 暂时为0，后续异步加载
                })
                .ToListAsync();

            // 添加系统管理入口
            basicHospitalInfo.Insert(0, new HospitalProject
            {
                hospitalId = Guid.Empty,
                hospitalName = "系统管理",
                projects = new(),
                patientsNum = 0,
                followupTasksNum = 0
            });

            hospitalProjects = basicHospitalInfo;
            isLoading = false;

            // 触发UI更新，显示基本信息
            StateHasChanged();

            // 第二步：异步加载统计数据（在后台继续执行）
            await LoadStatisticsData();
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "加载 AdminMain 基本数据时发生错误");
            isLoading = false;

            // 确保即使出错也有基本的系统管理入口
            hospitalProjects = new List<HospitalProject>
            {
                new HospitalProject
                {
                    hospitalId = Guid.Empty,
                    hospitalName = "系统管理",
                    projects = new(),
                    patientsNum = 0,
                    followupTasksNum = 0
                }
            };
        }
    }

    private async Task LoadStatisticsData()
    {
        try
        {
            // 批量加载统计数据（优化：使用字典提高查找效率）
            var hospitalIds = hospitalProjects.Where(h => h.hospitalId != Guid.Empty).Select(h => h.hospitalId).ToList();

            if (!hospitalIds.Any()) return;

            // 顺序执行查询（DbContext 不支持并发操作）
            var patientCounts = await _context.patient!
                .Where(p => hospitalIds.Contains(p.hospital_id) && p.source_type == "followup" && p.is_valid == true)
                .GroupBy(p => p.hospital_id)
                .Select(g => new { HospitalId = g.Key, Count = g.Count() })
                .ToDictionaryAsync(x => x.HospitalId, x => x.Count);

            var followupEventTypes = FollowupEventTypeExtensions.GetFollowupEventTypes();
            var followupCounts = await _context.patient_event
                .Join(_context.patient,
                    pe => pe.patient_id,
                    p => p.id,
                    (pe, p) => new { pe.event_type, p.hospital_id })
                .Where(x => hospitalIds.Contains(x.hospital_id) && followupEventTypes.Contains(x.event_type))
                .GroupBy(x => x.hospital_id)
                .Select(g => new { HospitalId = g.Key, Count = g.Count() })
                .ToDictionaryAsync(x => x.HospitalId, x => x.Count);

            // 更新统计数据（使用字典查找，O(1) 复杂度）
            foreach (var hospital in hospitalProjects.Where(h => h.hospitalId != Guid.Empty))
            {
                hospital.patientsNum = patientCounts.TryGetValue(hospital.hospitalId, out var pCount) ? pCount : 0;
                hospital.followupTasksNum = followupCounts.TryGetValue(hospital.hospitalId, out var fCount) ? fCount : 0;
                hospital.isStatisticsLoaded = true; // 标记统计数据已加载
            }
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "加载 AdminMain 统计数据时发生错误");

            // 即使出错也要标记为已加载，避免一直显示"加载中"
            foreach (var hospital in hospitalProjects.Where(h => h.hospitalId != Guid.Empty))
            {
                hospital.isStatisticsLoaded = true;
            }
        }
    }

    private void PageToHospital(Guid hospitalId)
    {
        if (hospitalId == Guid.Empty)
        {
            // TODO: [科室管理] - 实现科室管理页面
            // 功能说明：系统管理入口，用于管理科室、用户等系统级功能
            // 跳转来源：AdminMain 页面点击"系统管理"卡片
            // 路由参数：无
            inj_navigationManager.NavigateTo("/followupDeptMgr");
        }
        else
        {
            // TODO: [医院主页] - 实现医院主页
            // 功能说明：显示医院下的科室、课题、统计数据
            // 跳转来源：AdminMain 页面点击医院卡片
            // 路由参数：hospitalId - 医院ID
            inj_navigationManager.NavigateTo($"/hospitalMain?hospitalId={hospitalId}");
        }
    }


    private class HospitalProject
    {
        public Guid hospitalId { get; set; }
        public string hospitalName { get; set; } = "";
        public List<form_project> projects { get; set; } = new();
        public int patientsNum { get; set; } = 0;
        public int followupTasksNum { get; set; } = 0;
        public bool isStatisticsLoaded { get; set; } = false; // 统计数据加载状态
    }
}
