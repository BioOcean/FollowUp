@page "/departmentMain"
@using Microsoft.EntityFrameworkCore
@inherits BasePage

<PageTitle>科室概览</PageTitle>

@if (isLoading)
{
    <div class="department-main-container">
        <MudSkeleton Width="300px" Height="30px" Animation="Animation.Wave" Class="mb-4" />
        <div class="row mt-5">
            <div class="col-8">
                <MudSkeleton Height="400px" Animation="Animation.Wave" Class="mb-3" />
                <MudSkeleton Height="350px" Animation="Animation.Wave" Class="mb-3" />
                <MudSkeleton Height="450px" Animation="Animation.Wave" />
            </div>
            <div class="col-4">
                <MudSkeleton Height="200px" Animation="Animation.Wave" Class="mb-3" />
                <MudSkeleton Height="200px" Animation="Animation.Wave" />
            </div>
        </div>
    </div>
}
else if (hospital != null && currentDepartment != null)
{
    <div class="department-main-container">
        <div class="department-main-header">
            <div class="department-main-title">
                <span style="font-weight:700">数据范围：</span>
                <span>@hospital.name</span>
                <span class="ml-2">@(currentDepartment.display_name ?? currentDepartment.name)</span>
            </div>
            <div class="department-main-actions">
                <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@EditScanMsg" Class="button-press">编辑扫码信息</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@DownloadQrCode" Class="button-press">下载二维码</MudButton>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-8">
                @* 用户数据统计面板 - 复用医院主页组件 *@
                <HospitalMain_UserStatsPanel HospitalId="@hospital.id"
                                             DepartmentList="@departmentList"
                                             DepartmentProjects="@departmentProjectMaps" />

                @* 随访/宣教趋势 *@
                <HospitalMain_TrendPanel HospitalId="@hospital.id"
                                         DepartmentId="@currentDepartment.id"
                                         ProjectIds="@CurrentProjectIds" />

                @* 活跃度图表 *@
                <HospitalMain_ActivityPanel HospitalId="@hospital.id" ProjectIds="@CurrentProjectIds" />
            </div>

            <div class="col-4">
                @if (projectList.Any())
                {
                    @foreach (var project in projectList)
                    {
                        var summary = GetProjectSummary(project.id);
                        <DepartmentMain_ProjectCard Project="@project" Summary="@summary" />
                    }
                }
                else
                {
                    <MudAlert Severity="Severity.Info">该科室暂无课题信息</MudAlert>
                }
            </div>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-center align-center" style="height: 300px;">
        <MudText>未找到科室数据</MudText>
    </div>
}

@code {
    private ILogger<DepartmentMain> inj_logger => inj_loggerFactory.CreateLogger<DepartmentMain>();
    [Parameter]
    [SupplyParameterFromQuery]
    public string? departmentId { get; set; }

    private sys_hospital? hospital;
    private sys_department? currentDepartment;
    private List<sys_department> departmentList = new();
    private List<form_project> projectList = new();
    private List<DepartmentProjectMap> departmentProjectMaps = new();
    private Dictionary<Guid, ProjectSummaryDto> projectSummaries = new();
    private bool isLoading = true;

    private IReadOnlyCollection<Guid> CurrentProjectIds =>
        departmentProjectMaps.FirstOrDefault()?.ProjectIds ?? Array.Empty<Guid>();

    protected override async Task OnPageInitializedAsync()
    {
        try
        {
            if (string.IsNullOrEmpty(departmentId))
            {
                var user = inj_httpContextAccessor.HttpContext?.User;
                if (user?.Identity?.IsAuthenticated == true)
                {
                    departmentId = user.FindFirst("departmentId")?.Value;
                }
            }

            if (!string.IsNullOrEmpty(departmentId) && Guid.TryParse(departmentId, out var departmentGuid))
            {
                await LoadDataAsync(departmentGuid);
            }
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "DepartmentMain 初始化失败");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadDataAsync(Guid departmentGuid)
    {
        if (_context == null)
        {
            inj_logger.LogWarning("_context 未初始化，无法加载科室数据");
            return;
        }

        try
        {
            currentDepartment = await _context.sys_department!
                .AsNoTracking()
                .Include(d => d.hospital)
                .FirstOrDefaultAsync(d => d.id == departmentGuid);

            if (currentDepartment == null)
            {
                inj_logger.LogWarning("未找到科室信息，departmentId: {DepartmentId}", departmentGuid);
                return;
            }

            hospital = currentDepartment.hospital;
            departmentList = new List<sys_department> { currentDepartment };

            projectList = await _context.form_project
                .AsNoTracking()
                .Where(p => p.department_id == departmentGuid)
                .OrderBy(p => p.display_name ?? p.name)
                .ToListAsync();

            var projectIds = projectList
                .Select(p => p.id)
                .Where(id => id != Guid.Empty)
                .ToList();

            departmentProjectMaps = new List<DepartmentProjectMap>
            {
                new DepartmentProjectMap(
                    currentDepartment.id,
                    currentDepartment.display_name ?? currentDepartment.name ?? string.Empty,
                    projectIds)
            };

            if (hospital != null && projectIds.Any())
            {
                await LoadProjectSummariesAsync(hospital.id, projectIds);
            }

            inj_logger.LogInformation(
                "成功加载科室信息，科室: {DeptName}, 课题数量: {ProjCount}",
                currentDepartment.display_name ?? currentDepartment.name,
                projectList.Count);
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "加载科室数据失败，departmentId: {DepartmentId}", departmentGuid);
        }
    }

    private async Task LoadProjectSummariesAsync(Guid hospitalId, IReadOnlyCollection<Guid> projectIds)
    {
        try
        {
            var maps = projectList
                .Where(p => projectIds.Contains(p.id))
                .Select(p =>
                {
                    var name = p.display_name ?? p.name ?? string.Empty;
                    return new DepartmentProjectMap(p.id, name, new List<Guid> { p.id });
                })
                .ToList();

            if (!maps.Any())
            {
                projectSummaries = new Dictionary<Guid, ProjectSummaryDto>();
                return;
            }

            var summaries = await inj_overviewStatisticsService.GetDepartmentSummariesAsync(
                hospitalId,
                maps,
                CancellationToken.None);

            projectSummaries = summaries.Values.ToDictionary(
                s => s.DepartmentId,
                s => new ProjectSummaryDto(
                    s.DepartmentId,
                    s.DepartmentName,
                    s.PatientCount,
                    s.FollowupTaskCount,
                    s.FollowupRate,
                    s.StatusCounts));
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "加载课题统计数据失败");
            projectSummaries = new Dictionary<Guid, ProjectSummaryDto>();
        }
    }

    private ProjectSummaryDto? GetProjectSummary(Guid projectId)
    {
        return projectSummaries.TryGetValue(projectId, out var summary) ? summary : null;
    }

    private async Task EditScanMsg()
    {
        if (string.IsNullOrWhiteSpace(departmentId))
        {
            return;
        }

        if (!Guid.TryParse(departmentId, out var departmentGuid))
        {
            return;
        }

        var parameters = new DialogParameters
        {
            ["DepartmentId"] = departmentGuid
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.ExtraExtraLarge,
            FullScreen = false
        };

        await inj_dialogService.ShowAsync<EditScanDialog>("扫码信息", parameters, options);

        await LoadDataAsync(departmentGuid);
    }

    private async Task DownloadQrCode()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(departmentId) || currentDepartment == null)
            {
                inj_snackbar.Add("科室信息未加载完成，请稍后重试", Severity.Warning);
                return;
            }

            var deptName = currentDepartment.display_name ?? currentDepartment.name ?? "科室";
            var fileName = $"科室二维码_{deptName}.png";
            var success = await QrCodeDownloadHelper.DownloadAsync(
                inj_wechatService,
                inj_jsRuntime,
                inj_navigationManager,
                "f",
                departmentId,
                fileName,
                false,
                inj_logger);

            inj_snackbar.Add(success ? "二维码下载成功" : "生成二维码失败，请稍后重试", success ? Severity.Success : Severity.Error);
        }
        catch (Exception ex)
        {
            inj_logger.LogError(ex, "生成科室二维码时出错");
            inj_snackbar.Add($"生成二维码时出错: {ex.Message}", Severity.Error);
        }
    }
}
