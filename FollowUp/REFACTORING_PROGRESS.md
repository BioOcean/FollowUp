# FollowUp 重构进度跟踪

> **开始日期**：2025-01-12  
> **目标**：将 NTCare 系统重构为 FollowUp 系统

---

## 📊 总体进度

| 模块 | 状态 | 进度 | 负责人 | 备注 |
|------|------|------|--------|------|
| 登录系统 | ✅ 完成 | 100% | - | 已完成登录页面和认证流程 |
| 角色路由 | 🚧 进行中 | 30% | - | AdminMain 已完成，其他角色页面待实现 |
| 项目管理 | 🚧 进行中 | 20% | - | AdminMain 已完成 |
| 用户管理 | ⏸️ 待开始 | 0% | - | - |
| 医院管理 | ⏸️ 待开始 | 0% | - | - |
| 科室管理 | ⏸️ 待开始 | 0% | - | - |
| 课题管理 | ⏸️ 待开始 | 0% | - | - |
| 患者管理 | ⏸️ 待开始 | 0% | - | - |
| 随访计划 | ⏸️ 待开始 | 0% | - | - |
| 随访执行 | ⏸️ 待开始 | 0% | - | - |
| 数据统计 | ⏸️ 待开始 | 0% | - | - |

**图例**：
- ✅ 完成
- 🚧 进行中
- ⏸️ 待开始
- ❌ 已取消

---

## 📝 详细记录

### 1. 登录系统 ✅

**开始时间**：2025-01-12  
**完成时间**：2025-01-12  
**状态**：✅ 完成

#### 实现内容
- [x] Login.razor - 登录页面
- [x] LoginSystem.razor - 登录中转页
- [x] Welcome.razor - 欢迎页
- [x] RedirectToSignIn.razor - 未授权跳转组件
- [x] Login.razor.css - 登录页样式
- [x] auth.js - 认证脚本
- [x] 登录相关图片资源
- [x] common.css - 全局样式

#### 关键决策
- 使用 Bio.Core 认证系统
- 登录后跳转到 /welcome
- 未授权自动跳转到 /login

#### 遗留问题
- 无

---

### 2. 角色路由与主界面布局 🚧

**开始时间**：2025-01-13  
**完成时间**：-  
**状态**：🚧 进行中

#### 实现内容
- [x] Home.razor - 角色路由入口（简化版，待完善）
- [x] MainLayout.razor - 主界面布局
- [x] MainLayout.razor.css - 主界面样式
- [x] AdminMain.razor - 系统管理员主页（项目管理模块）
- [x] AdminMain.razor.css - AdminMain 样式
- [x] FollowupEventTypeExtensions.cs - 随访事件类型枚举
- [ ] NavMenuForFollowup.razor - 导航菜单（待实现）
- [ ] HospitalMain 页面（待实现）
- [ ] DepartmentMain 页面（待实现）
- [ ] ProjectMain 页面（待实现）
- [ ] FollowupTaskManager 页面（待实现）

#### 关键决策
1. **配置管理**：统一使用 `loginHospitalTitle` 配置项，登录页和主界面共用
2. **架构简化**：
   - 系统名称从配置文件读取，不使用缓存服务（FollowUp 单系统特性）
   - 权限检查直接从 Claims 读取，无需缓存
   - AdminMain 全局视图不维护"当前选择"状态
3. **数据库优化**：使用 `patient_event` 表 + 事件类型枚举统计随访任务，避免多表关联
4. **UI 实现**：
   - AppBar 颜色使用 CSS 变量 `var(--bioo-main)`
   - 完整复制 NTCare 的 `HelloMsg()` 时间问候逻辑
   - 用户名显示优先级：displayName > GivenName > Name

#### 涉及数据库表
| 表名 | Schema | 用途 |
|------|--------|------|
| form_form_set | form | 表单集（项目配置） |
| patient | public | 患者基本信息 |
| patient_event | care | 患者事件（随访任务） |
| sys_hospital | system | 医院信息 |
| sys_project | system | 项目信息 |

#### 遗留问题
- [ ] Home.razor 的完整角色路由逻辑（等待核心服务迁移）
- [ ] MainLayout 的导航菜单（NavMenu）待实现
- [ ] MainLayout 的完整注销逻辑（等待 JS 函数确认）
- [ ] AdminMain 跳转的目标页面（HospitalMain、FollowupDeptMgr）待实现

#### 迁移经验总结
本次迁移过程中遇到的问题和解决方案已更新到 `REFACTORING_GUIDE.md` 第八章：
1. **配置管理**：避免重复配置项，严格遵循 NTCare 命名规范
2. **架构简化决策**：区分"正式实现"与"待实现功能"，杜绝"临时方案"表述
3. **数据库查询优化**：根据数据结构选择最优查询方式
4. **服务依赖处理**：不盲目照搬，根据业务场景重新设计
5. **UI 深度分析**：必须逐行对比，不遗漏动态逻辑
6. **配置完整性验证**：验证实际用途，不凭感觉删除

---

### 3. 用户管理 ⏸️

**开始时间**：-  
**完成时间**：-  
**状态**：⏸️ 待开始

#### 计划内容
- [ ] 用户列表页
- [ ] 用户新增/编辑对话框
- [ ] 用户删除功能
- [ ] 用户角色管理
- [ ] 用户权限管理

#### 涉及数据库表
（待 MCP 查询确认，禁止猜测）

#### 待确认事项
- [ ] 是否需要用户导入/导出功能？
- [ ] 是否需要用户批量操作？
- [ ] 密码策略如何设置？

---

### 4. 医院管理 ⏸️

**开始时间**：-  
**完成时间**：-  
**状态**：⏸️ 待开始

#### 计划内容
- [ ] 医院列表页
- [ ] 医院新增/编辑对话框
- [ ] 医院删除功能
- [ ] 医院科室管理

#### 涉及数据库表
（待 MCP 查询确认，禁止猜测）

#### 待确认事项
- [ ] 是否需要医院层级管理？
- [ ] 是否需要医院审核流程？

---

### 5. 科室管理 ⏸️

**开始时间**：-  
**完成时间**：-  
**状态**：⏸️ 待开始

#### 计划内容
- [ ] 科室列表页
- [ ] 科室新增/编辑对话框
- [ ] 科室删除功能
- [ ] 科室人员管理

#### 涉及数据库表
（待 MCP 查询确认，禁止猜测）

#### 待确认事项
- [ ] 科室是否支持多级结构？
- [ ] 科室负责人如何设置？

---

### 6. 课题管理 ⏸️

**开始时间**：-  
**完成时间**：-  
**状态**：⏸️ 待开始

#### 计划内容
- [ ] 课题列表页
- [ ] 课题新增/编辑对话框
- [ ] 课题删除功能
- [ ] 课题成员管理
- [ ] 课题表单配置

#### 涉及数据库表
（待 MCP 查询确认，禁止猜测）

#### 待确认事项
- [ ] 课题审核流程如何设计？
- [ ] 课题权限如何控制？

---

### 7. 患者管理 ⏸️

**开始时间**：-  
**完成时间**：-  
**状态**：⏸️ 待开始

#### 计划内容
- [ ] 患者列表页
- [ ] 患者详情页
- [ ] 患者新增/编辑对话框
- [ ] 患者删除功能
- [ ] 患者导入/导出

#### 涉及数据库表
（待 MCP 查询确认，禁止猜测）

#### 待确认事项
- [ ] 患者信息脱敏如何处理？
- [ ] 患者导入格式如何定义？

---

### 8. 随访计划 ⏸️

**开始时间**：-  
**完成时间**：-  
**状态**：⏸️ 待开始

#### 计划内容
- [ ] 随访计划列表页
- [ ] 随访计划新增/编辑对话框
- [ ] 随访计划删除功能
- [ ] 随访计划模板管理

#### 涉及数据库表
（待 MCP 查询确认，禁止猜测）

#### 待确认事项
- [ ] 随访计划如何与课题关联？
- [ ] 随访提醒如何设置？

---

### 9. 随访执行 ⏸️

**开始时间**：-  
**完成时间**：-  
**状态**：⏸️ 待开始

#### 计划内容
- [ ] 随访任务列表页
- [ ] 随访表单填写页
- [ ] 随访记录查看页
- [ ] 随访数据导出

#### 涉及数据库表
（待 MCP 查询确认，禁止猜测）

#### 待确认事项
- [ ] 随访表单如何动态生成？
- [ ] 随访数据如何校验？

---

### 10. 数据统计 ⏸️

**开始时间**：-  
**完成时间**：-  
**状态**：⏸️ 待开始

#### 计划内容
- [ ] 统计报表页
- [ ] 数据可视化图表
- [ ] 报表导出功能

#### 涉及数据库表
- 多个表的聚合查询

#### 待确认事项
- [ ] 需要哪些统计维度？
- [ ] 报表格式如何定义？

---

## 🎯 里程碑

| 里程碑 | 目标日期 | 完成日期 | 状态 |
|--------|---------|---------|------|
| 登录系统完成 | 2025-01-12 | 2025-01-12 | ✅ |
| 角色路由与主界面布局 | - | - | 🚧 |
| 基础管理模块完成（用户/医院/科室） | - | - | ⏸️ |
| 课题管理模块完成 | - | - | ⏸️ |
| 患者管理模块完成 | - | - | ⏸️ |
| 随访模块完成 | - | - | ⏸️ |
| 统计模块完成 | - | - | ⏸️ |
| 系统测试完成 | - | - | ⏸️ |
| 上线部署 | - | - | ⏸️ |

---

## 📈 统计数据

### 代码统计

| 指标 | 数量 |
|------|------|
| 已创建模块 | 1 |
| 已创建页面 | 5 |
| 已创建组件 | 1 |
| 已创建服务/扩展 | 1 |
| 代码总行数 | ~1200 行 |

### 工作量统计

| 指标 | 数量 |
|------|------|
| 已完成功能点 | 1 |
| 进行中功能点 | 2 |
| 待开始功能点 | 8 |
| 总功能点 | 11 |
| 完成率 | 9% |

---

## 🐛 问题跟踪

### 已解决问题

| 问题 | 发现时间 | 解决时间 | 解决方案 |
|------|---------|---------|---------|
| 登录页样式不正确 | 2025-01-12 | 2025-01-12 | 创建 Login.razor.css 并复制图片资源 |
| 启动时默认页面不对 | 2025-01-12 | 2025-01-12 | 创建 RedirectToSignIn 组件 |
| 配置项重复（SystemName vs loginHospitalTitle） | 2025-01-13 | 2025-01-13 | 统一使用 loginHospitalTitle，移除冗余配置 |
| MainLayout 颜色硬编码 | 2025-01-13 | 2025-01-13 | 使用 CSS 变量 var(--bioo-main) |
| MainLayout 缺少动态问候 | 2025-01-13 | 2025-01-13 | 完整复制 NTCare 的 HelloMsg() 方法 |
| 模块 _Imports.razor 编译错误 | 2025-01-13 | 2025-01-13 | 注释掉空子目录的 using 语句 |
| AdminMain 使用 followup_record 表查询效率低 | 2025-01-13 | 2025-01-13 | 改用 patient_event 表 + 枚举类型 |

### 待解决问题

| 问题 | 发现时间 | 优先级 | 负责人 | 备注 |
|------|---------|--------|--------|------|
| - | - | - | - | - |

---

## 📌 备注

### 重要决策记录

1. **2025-01-12**：确定采用模块化架构，遵循 CLAUDE.md 规范
2. **2025-01-12**：确定只参考 NTCare 业务逻辑，代码结构完全重写
3. **2025-01-12**：确定使用 Bio.Core 认证系统
4. **2025-01-12**：明确数据库架构（多 schema 设计）
   - system：系统管理（13 表）
   - form：表单系统（6 表）
   - followup：随访管理（35 表）
   - care：护理管理（11 表）
   - target：临床数据（327 表）
   - public：患者数据（4 表）
5. **2025-01-12**：所有数据库查询必须使用 `mcp_postgres_query` 工具，禁止猜测表名
6. **2025-01-12**：确定重构策略为"理解业务需求，重新设计实现"
   - 可以重新简化代码结构并重新实现
   - 可以合并冗余字段、优化表结构
   - 数据库改动必须提供迁移方案和回滚方案
   - 必须评估数据迁移风险和影响
7. **2025-01-12**：明确 UI 布局和样式处理原则（最高优先级）
   - ⛔ **UI 布局和样式必须完全参考 NTCare**
   - ⛔ **未经用户明确同意，不得修改 UI 风格**
   - ⛔ **如有 UI 优化建议，必须先征得用户同意**
   - ✅ 使用 MudBlazor 组件复现 NTCare 的 UI 效果
   - ✅ 样式文件从 NTCare 复制后微调
8. **2025-01-13**：AdminMain 迁移关键决策
   - 配置管理：统一使用 `loginHospitalTitle`，不新增冗余配置
   - 架构简化：基于业务差异（单系统 vs 多系统）选择极简实现
   - 数据库优化：使用 `patient_event` + 枚举替代 `followup_record` 多表关联
   - 服务依赖：权限检查直接用 Claims，无需缓存
   - UI 实现：严格遵守颜色变量、动态文本、时间问候等所有细节
9. **2025-01-13**：明确"临时方案"与"正式实现"的区分标准
   - ⛔ **禁止使用"临时"这种模糊表述**
   - ✅ 基于业务差异的架构决策 = 正式实现（需注释说明）
   - ✅ 当前功能不完整 = 待实现功能（用 TODO 标记）

### 技术债务

| 债务 | 影响 | 计划解决时间 |
|------|------|-------------|
| - | - | - |

### 优化建议

| 建议 | 优先级 | 状态 |
|------|--------|------|
| - | - | - |

---

## 📚 参考资料

- [REFACTORING_GUIDE.md](./REFACTORING_GUIDE.md) - 重构指导文档
- [CLAUDE.md](./CLAUDE.md) - 项目结构规范
- NTCare 源代码：`F:\project\NTCare\`

---

**更新日期**：2025-01-13  
**下次更新**：每完成一个模块后更新

---

## 📖 变更日志

### 2025-01-13
- ✅ 完成 AdminMain 页面迁移（系统管理员主页）
- ✅ 完成 MainLayout 主界面布局
- ✅ 创建 FollowupEventTypeExtensions 随访事件枚举
- ✅ 更新 REFACTORING_GUIDE.md，新增第八章"迁移经验与常见问题"
- 📝 记录了 7 个关键问题和解决方案
- 📝 总结了配置管理、架构简化、数据库优化、UI 实现等经验

### 2025-01-12
- ✅ 完成登录系统（Login.razor、LoginSystem.razor、Welcome.razor）
- ✅ 完成认证流程和 RedirectToSignIn 组件
- ✅ 创建 REFACTORING_GUIDE.md 和 REFACTORING_PROGRESS.md

