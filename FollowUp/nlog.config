<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      throwConfigExceptions="true">

  <!-- enable asp.net core layout renderers -->
  <extensions>
    <add assembly="NLog.Web.AspNetCore"/>
  </extensions>

  <!-- 定义日志目标 -->
  <targets>
    <!-- 控制台日志 -->
    <target xsi:type="Console" name="console" 
            layout="${longdate} | ${level:uppercase=true} | ${logger} | ${message} ${exception:format=toString}" />

    <!-- 新增: NotificationOrchestrator 日志文件 -->
    <target xsi:type="File" name="notificationFile" 
            fileName="logs/${date:format=yyyy}/${date:format=MM}/${date:format=dd}/${date:format=HH}_notifi.log"
            layout="${longdate} | ${level:uppercase=true} | ${logger} | ${message} ${exception:format=toString}" />

    <!-- Error日志文件 -->
    <target xsi:type="File" name="errorFile" 
            fileName="logs/${date:format=yyyy}/${date:format=MM}/${date:format=dd}/${date:format=HH}_error.log"  
            layout="${longdate} | ${level:uppercase=true} | ${logger} | ${message} ${exception:format=toString}" />
    
    <!-- Warning日志文件 -->
    <target xsi:type="File" name="warnFile" 
            fileName="logs/${date:format=yyyy}/${date:format=MM}/${date:format=dd}/${date:format=HH}_warn.log"
            layout="${longdate} | ${level:uppercase=true} | ${logger} | ${message} ${exception:format=toString}" />
    
    <!-- Info日志文件 -->
    <target xsi:type="File" name="infoFile" 
            fileName="logs/${date:format=yyyy}/${date:format=MM}/${date:format=dd}/${date:format=HH}_info.log"
            layout="${longdate} | ${level:uppercase=true} | ${logger} | ${message} ${exception:format=toString}" />
    
    <!-- Debug日志文件 -->
    <!--<target xsi:type="File" name="debugFile"
            fileName="logs/${date:format=yyyy}/${date:format=MM}/${date:format=dd}/${date:format=HH}_debug.log"
            layout="${longdate} | ${level:uppercase=true} | ${logger} | ${message} ${exception:format=toString}" />-->

    <!-- 内存监控专用日志文件 -->
    <target xsi:type="File" name="memoryMonitorFile"
            fileName="logs/${date:format=yyyy}/${date:format=MM}/${date:format=dd}/${date:format=HH}_memory_monitor.log"
            layout="${longdate} | ${level:uppercase=true} | ${logger} | ${threadid} | ${callsite:className=true:fileName=false:methodName=true} | ${message}${onexception:${newline}${exception:format=toString,Data:maxInnerExceptionLevel=5}}" />

    <!-- 性能监控日志文件 -->
    <target xsi:type="File" name="performanceFile"
            fileName="logs/${date:format=yyyy}/${date:format=MM}/${date:format=dd}/${date:format=HH}_performance.log"
            layout="${longdate} | ${level:uppercase=true} | ${logger} | ${message} ${exception:format=toString}" />
  </targets>

  <!-- 定义日志规则 -->
  <rules>
    <!-- 新增: 将 NotificationOrchestrator 的所有级别日志写入到 notificationFile -->
    <logger name="FollowUp.Notification.NotificationOrchestrator" minlevel="Trace" writeTo="notificationFile" final="true" />

    <!-- 新增: 性能监控服务的日志 -->
    <logger name="FollowUp.Notification.Services.NotificationPerformanceMonitor" minlevel="Information" writeTo="notificationFile" final="true" />
    <logger name="FollowUp.Notification.Services.SenderService" minlevel="Information" writeTo="notificationFile" final="true" />
    <logger name="FollowUp.Notification.Providers.FollowupTaskProvider" minlevel="Information" writeTo="notificationFile" final="true" />

    <!-- 新增: 微信映射缓存服务的日志 -->
    <logger name="FollowUp.Service.WeChatMappingCache" minlevel="Information" writeTo="infoFile" final="true" />

    <!-- 新增: 内存监控服务的详细日志 -->
    <logger name="FollowUp.Service.MemoryMonitorService" minlevel="Trace" writeTo="memoryMonitorFile" final="true" />

    <!-- 新增: 内存清理作业的日志 -->
    <logger name="FollowUp.Notification.NotificationBackgroundService.MemoryCleanupJob" minlevel="Information" writeTo="memoryMonitorFile" final="true" />

    <!-- 注意：移除程序启动内存清理日志规则，因为已移除相关代码 -->

    <!-- 新增: FollowupService的性能相关日志 -->
    <logger name="FollowUp.Service.FollowupService" minlevel="Information" writeTo="infoFile" final="true" />

    <!-- 将所有Error及以上级别的日志写入errorFile (排除NotificationOrchestrator) -->
    <logger name="*" minlevel="Error" writeTo="errorFile" /> 
    
    <!-- 将所有Warn级别的日志写入warnFile (排除NotificationOrchestrator) -->
    <logger name="*" level="Warn" writeTo="warnFile" />
    
    <!-- 将所有Info级别的日志写入infoFile (排除NotificationOrchestrator) -->
    <logger name="*" level="Info" writeTo="infoFile" />
    
    <!-- 将所有Debug级别的日志写入debugFile (排除NotificationOrchestrator) -->
    <!--<logger name="*" level="Debug" writeTo="debugFile" />-->

    <!-- 如果需要，可以保留或添加控制台日志规则 -->
    <logger name="*" minlevel="Warn" writeTo="console" />
  </rules>
</nlog>